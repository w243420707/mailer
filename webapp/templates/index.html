<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mailer 配置管理</title>
    <link rel="stylesheet" href="/static/styles.css?v=20251117" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="title">Mailer 配置管理</div>
        <div class="subtitle">批量发送 · 模板变量 · 进度跟踪</div>
      </div>

      <div class="layout-grid">
        <!-- 左列：配置 / 粘贴发送 -->
        <div class="stack">
          <div class="card" id="card-config">
            <h3>连接与主题</h3>
            <form id="cfgForm" onsubmit="return false;">
              <section>
                <div class="row">
                  <label class="muted">面板地址(server)</label>
                  <input id="postal.server" class="input" type="text" placeholder="https://your-postal" />
                </div>
                <div class="row">
                  <label class="muted">API Key</label>
                  <input id="postal.key" class="input" type="password" placeholder="API Key" />
                </div>
              </section>
              <section>
                <small class="muted">填写 1~5 个主题，发送时轮询；可在下方临时覆盖。</small>
                <div class="subjects" style="margin-top:10px;">
                  <input id="setting.subject1" class="input" type="text" placeholder="主题1" />
                  <input id="setting.subject2" class="input" type="text" placeholder="主题2" />
                  <input id="setting.subject3" class="input" type="text" placeholder="主题3" />
                  <input id="setting.subject4" class="input" type="text" placeholder="主题4" />
                  <input id="setting.subject5" class="input" type="text" placeholder="主题5" />
                </div>
                <div class="row" style="margin-top:14px;">
                  <label class="muted">代理(proxy)</label>
                  <input id="setting.proxy" class="input" type="text" placeholder="http://ip:port" />
                </div>
              </section>
              <section>
                <div class="toolbar">
                  <button id="save" class="btn btn-primary" type="button">保存配置</button>
                  <button id="refresh" class="btn btn-ghost" type="button">刷新</button>
                  <span id="saveMsg" class="muted"></span>
                </div>
              </section>
            </form>
          </div>

          <div class="card" id="card-send-list">
            <h3>粘贴发送（支持去重）</h3>
            <section>
              <div class="row">
                <label class="muted">收件人</label>
                <textarea id="recipients_text" class="textarea" placeholder="a@example.com\nb@example.com\n..."></textarea>
              </div>
              <div class="toolbar">
                <label class="muted"><input id="dedupe" type="checkbox" checked /> 去重</label>
              </div>
            </section>
            <section>
              <div class="row">
                <label class="muted">主题覆盖（留空轮询）</label>
                <input id="subject_override" class="input" type="text" placeholder="本次统一主题，可留空" />
              </div>
              <div class="row">
                <label class="muted">邮件内容（HTML）</label>
                <textarea id="body_html" class="textarea" placeholder="<p>您好...</p>\n<!-- 支持 {{email}} / {{index}} / {{domain}} -->"></textarea>
              </div>
            </section>
            <section>
              <div class="toolbar">
                <button id="sendList" class="btn btn-primary" type="button">发送本次列表</button>
                <button id="saveOnly" class="btn btn-ghost" type="button">仅保存</button>
                <button id="sendAll" class="btn btn-success" type="button">发送已累积</button>
              </div>
            </section>
          </div>
        </div>

        <!-- 右列：结果 / 进度 / 收件人 / 原始配置 -->
        <div class="stack">
          <div class="card" id="card-result">
            <h3>发送结果</h3>
            <div class="toolbar">
              <button id="last" class="btn btn-ghost" type="button">获取上次结果</button>
            </div>
            <pre id="result" style="margin-top:12px; max-height:240px;"></pre>
          </div>
          <div class="card" id="card-progress">
            <h3>发送进度</h3>
            <div class="progress"><div id="progBar" class="bar"></div></div>
            <div id="progText" class="muted" style="margin-top:10px;">状态：idle</div>
          </div>
          <div class="card" id="card-recipients">
            <h3>收件人列表 <span class="badge" id="recTotal">0</span></h3>
            <div class="toolbar" style="margin-bottom:8px;">
              <button id="expRec" class="btn btn-ghost" type="button">导出</button>
              <button id="clearRec" class="btn btn-danger" type="button">清空</button>
            </div>
            <pre id="recPreview" style="max-height:220px;"></pre>
          </div>
          <div class="card" id="card-config-json">
            <h3>原始配置 JSON</h3>
            <details open>
              <summary class="muted" style="cursor:pointer;">折叠/展开</summary>
              <pre id="config" style="margin-top:12px; max-height:260px;"></pre>
            </details>
          </div>
          <div class="footer-note">Mailer UI · 简化批量发送流程</div>
        </div>
      </div>
    </div>

    <div>
      <h3>发送结果</h3>
      <button id="last">获取上次结果</button>
      <pre id="result"></pre>
    </div>

    <hr/>
    <div>
      <h3>粘贴收件人列表发送（支持去重）</h3>
      <div style="max-width: 800px;">
        <label>
          收件人（换行/逗号/分号分隔）
          <textarea id="recipients_text" rows="8" style="width:100%;" placeholder="a@example.com\nb@example.com\nc@example.com"></textarea>
        </label>
        <div style="margin:6px 0;">
          <label><input id="dedupe" type="checkbox" checked /> 去重</label>
        </div>
        <label>
          主题（留空则使用配置中的 subject）
          <input id="subject_override" type="text" style="width:100%;" />
        </label>
        <label>
          邮件内容（HTML）
          <textarea id="body_html" rows="10" style="width:100%;" placeholder="<p>您好...</p>"></textarea>
          <small>支持占位：{{email}}、{{index}}、{{domain}}</small>
        </label>
        <div style="margin-top:8px;">
          <button id="sendList">发送粘贴列表（后台）</button>
          <button id="saveOnly" type="button">仅保存不发送</button>
          <button id="sendAll" type="button">对已累积收件人发送</button>
        </div>
      </div>
    </div>

    <hr/>
    <div>
      <h3>收件人列表（recipients.txt）</h3>
      <div>
        <span>总数：<b id="recTotal">0</b></span>
        <button id="expRec">导出</button>
        <button id="clearRec">清空</button>
      </div>
      <pre id="recPreview" style="max-height: 200px; overflow:auto; background:#f7f7f7; padding:8px;"></pre>
    </div>

    <hr/>
    <div>
      <h3>发送进度</h3>
      <div style="width:100%;max-width:600px;background:#eee;height:16px;border-radius:8px;overflow:hidden;">
        <div id="progBar" style="width:0%;height:100%;background:#4caf50;"></div>
      </div>
      <div id="progText" style="margin-top:6px;color:#333;">状态：idle</div>
    </div>
    <details>
      <summary>查看原始配置 JSON</summary>
      <pre id="config">加载中...</pre>
    </details>

    <script src="/static/main.js"></script>
  </body>
</html>
